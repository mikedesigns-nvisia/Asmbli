name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.0.0'
          channel: 'stable'
      
      - name: Install dependencies
        run: |
          cd apps/desktop
          flutter pub get
          cd ../../packages/agent_engine_core
          flutter pub get
      
      - name: Analyze code
        run: |
          cd apps/desktop
          flutter analyze
      
      - name: Check formatting
        run: |
          cd apps/desktop
          dart format --set-exit-if-changed .

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v3
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.0.0'
          channel: 'stable'
      
      - name: Install dependencies
        run: |
          cd apps/desktop
          flutter pub get
      
      - name: Run tests
        run: |
          cd apps/desktop
          flutter test --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: apps/desktop/coverage/lcov.info

  build:
    name: Build
    runs-on: ${{ matrix.os }}
    needs: test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v3
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.0.0'
          channel: 'stable'
      
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev
      
      - name: Install dependencies
        run: |
          cd apps/desktop
          flutter pub get
      
      - name: Build app
        run: |
          cd apps/desktop
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            flutter build linux
          elif [ "${{ matrix.os }}" == "windows-latest" ]; then
            flutter build windows
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            flutter build macos
          fi
        shell: bash
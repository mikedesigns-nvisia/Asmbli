<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Excalidraw Canvas</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@excalidraw/excalidraw@0.17.6/dist/excalidraw.production.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #app { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        const { Excalidraw, convertToExcalidrawElements } = ExcalidrawLib;
        
        // Global API reference
        let excalidrawAPI = null;
        let isReady = false;
        
        // Store for pending operations
        const pendingOperations = [];
        
        // Expose functions to Flutter with detailed debugging
        window.addCanvasElement = function(elementData) {
            if (!isReady || !excalidrawAPI) {
                pendingOperations.push({ type: 'add', data: elementData });
                return;
            }
            
            try {
                const element = typeof elementData === 'string' 
                    ? JSON.parse(elementData) 
                    : elementData;
                
                const newElements = convertToExcalidrawElements([element]);
                
                // Get current scene elements
                console.log('üìã Getting current scene elements...');
                const currentElements = excalidrawAPI.getSceneElements();
                
                // Fast update
                excalidrawAPI.updateScene({
                    elements: [...currentElements, ...newElements],
                });
                
                // Notify Flutter of success
                if (window.flutter_inappwebview?.callHandler) {
                    window.flutter_inappwebview.callHandler('flutter_inappwebview', JSON.stringify({
                        type: 'elementAdded',
                        success: true,
                        elementId: newElements[0].id
                    }));
                }
                
            } catch (error) {
                console.error('‚ùå Error adding element:', error);
                console.error('‚ùå Stack trace:', error.stack);
                if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
                    window.flutter_inappwebview.callHandler('flutter_inappwebview', JSON.stringify({
                        type: 'elementAdded',
                        success: false,
                        error: error.message,
                        stack: error.stack
                    }));
                }
            }
        };
        
        window.updateCanvasElement = function(elementData) {
            if (!isReady || !excalidrawAPI) {
                pendingOperations.push({ type: 'update', data: elementData });
                return;
            }
            
            try {
                const element = typeof elementData === 'string' 
                    ? JSON.parse(elementData) 
                    : elementData;
                
                const currentElements = excalidrawAPI.getSceneElements();
                const updatedElements = currentElements.map(el => 
                    el.id === element.id ? { ...el, ...element } : el
                );
                
                excalidrawAPI.updateScene({
                    elements: updatedElements,
                });
                
            } catch (error) {
                console.error('‚ùå Error updating element:', error);
            }
        };
        
        window.clearCanvas = function() {
            if (!isReady || !excalidrawAPI) {
                pendingOperations.push({ type: 'clear', data: null });
                return;
            }
            
            excalidrawAPI.updateScene({
                elements: [],
            });
        };
        
        window.getCanvasElements = function() {
            if (!isReady || !excalidrawAPI) {
                return JSON.stringify([]);
            }
            
            const elements = excalidrawAPI.getSceneElements();
            return JSON.stringify(elements);
        };
        
        // Template functions for common layouts
        window.addWireframeElements = function() {
            if (!isReady || !excalidrawAPI) {
                pendingOperations.push({ type: 'wireframe', data: null });
                return;
            }
            
            const wireframeElements = [
                {
                    type: 'rectangle',
                    x: 100,
                    y: 100,
                    width: 300,
                    height: 60,
                    label: { text: 'Header' }
                },
                {
                    type: 'rectangle', 
                    x: 100,
                    y: 180,
                    width: 140,
                    height: 200,
                    label: { text: 'Sidebar' }
                },
                {
                    type: 'rectangle',
                    x: 260,
                    y: 180, 
                    width: 140,
                    height: 200,
                    label: { text: 'Content' }
                }
            ];
            
            const newElements = convertToExcalidrawElements(wireframeElements);
            const currentElements = excalidrawAPI.getSceneElements();
            
            excalidrawAPI.updateScene({
                elements: [...currentElements, ...newElements],
            });
        };
        
        window.addMobileAppTemplate = function() {
            if (!isReady || !excalidrawAPI) {
                pendingOperations.push({ type: 'mobile', data: null });
                return;
            }
            
            const mobileElements = [
                {
                    type: 'rectangle',
                    x: 150,
                    y: 100,
                    width: 250,
                    height: 400,
                    strokeWidth: 3,
                    label: { text: 'Mobile App Frame' }
                },
                {
                    type: 'rectangle',
                    x: 170,
                    y: 120,
                    width: 210,
                    height: 50,
                    label: { text: 'Header' }
                },
                {
                    type: 'rectangle',
                    x: 170,
                    y: 190,
                    width: 210,
                    height: 250,
                    label: { text: 'Content Area' }
                },
                {
                    type: 'rectangle',
                    x: 170,
                    y: 460,
                    width: 210,
                    height: 20,
                    label: { text: 'Bottom Nav' }
                }
            ];
            
            const newElements = convertToExcalidrawElements(mobileElements);
            const currentElements = excalidrawAPI.getSceneElements();
            
            excalidrawAPI.updateScene({
                elements: [...currentElements, ...newElements],
            });
        };
        
        // Process pending operations
        function processPendingOperations() {
            console.log(`üì¶ Processing ${pendingOperations.length} pending operations`);
            
            while (pendingOperations.length > 0) {
                const op = pendingOperations.shift();
                
                switch (op.type) {
                    case 'add':
                        window.addCanvasElement(op.data);
                        break;
                    case 'update':
                        window.updateCanvasElement(op.data);
                        break;
                    case 'clear':
                        window.clearCanvas();
                        break;
                    case 'wireframe':
                        window.addWireframeElements();
                        break;
                    case 'mobile':
                        window.addMobileAppTemplate();
                        break;
                }
            }
        }
        
        // Modern React component using official best practices
        function App() {
            const [excalidrawAPI, setExcalidrawAPI] = React.useState(null);
            
            // Handle API initialization - modern approach
            React.useEffect(() => {
                if (excalidrawAPI) {
                    // Store global reference
                    window.excalidrawAPI = excalidrawAPI;
                    isReady = true;
                    
                    console.log('‚úÖ Excalidraw API ready (modern pattern)');
                    
                    // Small delay to ensure React render is complete
                    setTimeout(() => {
                        // Test API functionality
                        try {
                            const currentElements = excalidrawAPI.getSceneElements();
                            console.log('üß™ API test successful, current elements:', currentElements.length);
                            
                            // Set global ready flag
                            window.excalidrawReady = true;
                            window.excalidrawInitTimestamp = Date.now();
                            
                            // Notify Flutter using the channel pattern
                            if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
                                window.flutter_inappwebview.callHandler('flutter_inappwebview', JSON.stringify({
                                    type: 'webViewReady',
                                    apiTested: true,
                                    timestamp: Date.now()
                                }));
                                console.log('üì° Sent verified ready signal to Flutter');
                            }
                            
                            // Process any pending operations
                            processPendingOperations();
                            
                        } catch (apiError) {
                            console.error('‚ùå API test failed:', apiError);
                            // Don't mark as ready if API isn't working
                        }
                    }, 50); // Small delay for React render completion
                }
            }, [excalidrawAPI]); // Dependency on the API state
            
            return React.createElement(
                'div',
                { style: { height: '100%', width: '100%' } },
                React.createElement(Excalidraw, {
                    // Official pattern: capture API reference
                    excalidrawAPI: (api) => {
                        console.log('üîó Excalidraw API received:', !!api);
                        setExcalidrawAPI(api);
                    },
                    onChange: (elements, appState, files) => {
                        // Notify Flutter of changes
                        if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
                            window.flutter_inappwebview.callHandler('flutter_inappwebview', JSON.stringify({
                                type: 'drawingChanged',
                                hasContent: elements.length > 0,
                                elementCount: elements.length
                            }));
                        }
                    },
                })
            );
        }
        
        // ===== COMPREHENSIVE TEST SUITE =====
        window.runTestSuite = function() {
            console.log('\nüß™ === STARTING COMPREHENSIVE TEST SUITE ===');
            
            // Test 1: Basic API availability
            console.log('üîç TEST 1: API Availability');
            console.log('- ExcalidrawLib exists:', typeof ExcalidrawLib !== 'undefined');
            console.log('- convertToExcalidrawElements exists:', typeof convertToExcalidrawElements !== 'undefined');
            console.log('- excalidrawAPI exists:', !!excalidrawAPI);
            console.log('- isReady flag:', isReady);
            
            if (!excalidrawAPI) {
                console.log('‚ùå TEST 1 FAILED: No excalidrawAPI');
                return;
            }
            
            // Test 2: API Methods
            console.log('\nüîç TEST 2: API Methods');
            console.log('- getSceneElements:', typeof excalidrawAPI.getSceneElements);
            console.log('- updateScene:', typeof excalidrawAPI.updateScene);
            
            try {
                const elements = excalidrawAPI.getSceneElements();
                console.log('- Current elements:', elements.length);
                console.log('‚úÖ TEST 2 PASSED: API methods work');
            } catch (e) {
                console.log('‚ùå TEST 2 FAILED:', e.message);
                return;
            }
            
            // Test 3: Element Creation
            console.log('\nüîç TEST 3: Element Creation');
            try {
                const testElement = {
                    type: 'rectangle',
                    x: 50,
                    y: 50,
                    width: 100,
                    height: 50,
                    strokeColor: '#ff0000'
                };
                
                console.log('- Creating test element:', testElement);
                const converted = convertToExcalidrawElements([testElement]);
                console.log('- Converted elements:', converted);
                
                const beforeCount = excalidrawAPI.getSceneElements().length;
                excalidrawAPI.updateScene({
                    elements: [...excalidrawAPI.getSceneElements(), ...converted]
                });
                const afterCount = excalidrawAPI.getSceneElements().length;
                
                console.log('- Elements before:', beforeCount, 'after:', afterCount);
                
                if (afterCount > beforeCount) {
                    console.log('‚úÖ TEST 3 PASSED: Element creation works');
                } else {
                    console.log('‚ùå TEST 3 FAILED: Element count unchanged');
                }
            } catch (e) {
                console.log('‚ùå TEST 3 FAILED:', e.message);
            }
            
            // Test 4: Multiple Elements
            console.log('\nüîç TEST 4: Multiple Element Types');
            try {
                const elements = [
                    { type: 'ellipse', x: 200, y: 50, width: 80, height: 60, strokeColor: '#0066cc' },
                    { type: 'diamond', x: 350, y: 50, width: 70, height: 70, strokeColor: '#009900' },
                    { type: 'arrow', x: 120, y: 150, width: 100, height: 2, strokeColor: '#cc6600' }
                ];
                
                const beforeCount = excalidrawAPI.getSceneElements().length;
                const converted = convertToExcalidrawElements(elements);
                excalidrawAPI.updateScene({
                    elements: [...excalidrawAPI.getSceneElements(), ...converted]
                });
                const afterCount = excalidrawAPI.getSceneElements().length;
                
                console.log('- Added', elements.length, 'elements');
                console.log('- Count change:', afterCount - beforeCount);
                
                if (afterCount >= beforeCount + elements.length) {
                    console.log('‚úÖ TEST 4 PASSED: Multiple elements work');
                } else {
                    console.log('‚ùå TEST 4 FAILED: Expected', elements.length, 'got', afterCount - beforeCount);
                }
            } catch (e) {
                console.log('‚ùå TEST 4 FAILED:', e.message);
            }
            
            console.log('\nüéØ === TEST SUITE COMPLETE ===\n');
        };
        
        window.clearTestElements = function() {
            console.log('üßπ Clearing all elements');
            excalidrawAPI.updateScene({ elements: [] });
            console.log('‚úÖ Canvas cleared');
        };
        
        window.getElementStats = function() {
            const elements = excalidrawAPI.getSceneElements();
            const stats = {
                total: elements.length,
                byType: elements.reduce((acc, el) => {
                    acc[el.type] = (acc[el.type] || 0) + 1;
                    return acc;
                }, {})
            };
            console.log('üìä Element Stats:', stats);
            return stats;
        };
        
        // Render app (React 18 compatible)
        const container = document.getElementById('app');
        const root = ReactDOM.createRoot ? ReactDOM.createRoot(container) : container;
        
        if (ReactDOM.createRoot) {
            root.render(React.createElement(App));
        } else {
            ReactDOM.render(React.createElement(App), container);
        }
        
        console.log('üöÄ Excalidraw initialized with native API');
        
        // Fallback ready signal (in case React initialization takes too long)
        setTimeout(() => {
            if (!isReady) {
                console.log('‚ö†Ô∏è React/Excalidraw taking time, sending fallback ready signal');
                try {
                    if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
                        window.flutter_inappwebview.callHandler('flutter_inappwebview', JSON.stringify({
                            type: 'webViewReady'
                        }));
                        console.log('üì° Sent fallback webViewReady signal');
                    }
                } catch (e) {
                    console.error('‚ùå Fallback ready signal failed:', e);
                }
            }
        }, 3000); // Wait 3 seconds then send fallback
    </script>
</body>
</html>
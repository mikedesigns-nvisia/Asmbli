import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/design_system/design_system.dart';
import '../../../../core/constants/routes.dart';
import '../providers/context_provider.dart';
import '../../data/repositories/context_repository.dart';
import '../widgets/context_document_card.dart';
import '../widgets/context_creation_flow.dart';
import '../widgets/context_filter_bar.dart';
import '../widgets/context_hub_widget.dart';
import '../../data/models/context_document.dart';

class ContextScreen extends ConsumerStatefulWidget {
  const ContextScreen({super.key});

  @override
  ConsumerState<ContextScreen> createState() => _ContextScreenState();
}

class _ContextScreenState extends ConsumerState<ContextScreen> {
  ContextType? _selectedType;
  String _searchQuery = '';
  bool _showCreateForm = false;

  @override
  Widget build(BuildContext context) {
    final colors = ThemeColors(context);
    final contextDocuments = ref.watch(contextDocumentsProvider);
    
    return Scaffold(
      body: Container(
        decoration: BoxDecoration(
          gradient: RadialGradient(
            center: Alignment.topCenter,
            radius: 1.5,
            colors: [
              colors.backgroundGradientStart,
              colors.backgroundGradientMiddle,
              colors.backgroundGradientEnd,
            ],
            stops: const [0.0, 0.6, 1.0],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // App Header
              const AppNavigationBar(currentRoute: AppRoutes.context),
              
              // Main Content
              Expanded(
                child: contextDocuments.when(
                  data: (documents) => _buildContent(context, documents),
                  loading: () => const Center(
                    child: CircularProgressIndicator(),
                  ),
                  error: (error, stackTrace) => const Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.error_outline,
                          size: 48,
                          color: colors.error,
                        ),
                        SizedBox(height: SpacingTokens.componentSpacing),
                        Text(
                          'Error loading context documents',
                          style: TextStyles.pageTitle.copyWith(
                            color: colors.onSurface,
                          ),
                        ),
                        SizedBox(height: SpacingTokens.iconSpacing),
                        Text(
                          error.toString(),
                          style: TextStyles.bodyMedium.copyWith(
                            color: colors.onSurfaceVariant,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildContent(BuildContext context, List<ContextDocument> allDocuments) {
    final colors = ThemeColors(context);
    
    // Filter documents based on search and type
    final filteredDocuments = allDocuments.where((doc) {
      final matchesSearch = _searchQuery.isEmpty ||
          doc.title.toLowerCase().contains(_searchQuery.toLowerCase()) ||
          doc.content.toLowerCase().contains(_searchQuery.toLowerCase()) ||
          doc.tags.any((tag) => tag.toLowerCase().contains(_searchQuery.toLowerCase()));
      
      final matchesType = _selectedType == null || doc.type == _selectedType;
      
      return doc.isActive && matchesSearch && matchesType;
    }).toList();

    return SingleChildScrollView(
      padding: EdgeInsets.all(SpacingTokens.pageHorizontal),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Page Header
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'Context Management',
                    style: TextStyles.pageTitle.copyWith(
                      color: colors.onSurface,
                    ),
                  ),
                  SizedBox(height: SpacingTokens.iconSpacing),
                  Text(
                    'Manage context documents that can be assigned to agents',
                    style: TextStyles.bodyLarge.copyWith(
                      color: colors.onSurfaceVariant,
                    ),
                  ),
                ],
              ),
              AsmblButtonEnhanced.accent(
                text: 'Create Document',
                icon: Icons.add,
                onPressed: () => setState(() => _showCreateForm = true),
                size: AsmblButtonSize.medium,
              ),
            ],
          ),

          SizedBox(height: SpacingTokens.sectionSpacing),

          // Context Hub Widget
          const ContextHubWidget(),
          
          SizedBox(height: SpacingTokens.sectionSpacing),

          // Create Form (conditionally shown)
          if (_showCreateForm) ...[
            ContextCreationFlow(
              onSave: (document) async {
                await ref.read(contextRepositoryProvider).createDocument(
                  title: document.title,
                  content: document.content,
                  type: document.type,
                  tags: document.tags,
                );
                ref.invalidate(contextDocumentsProvider);
                setState(() => _showCreateForm = false);
              },
              onCancel: () => setState(() => _showCreateForm = false),
            ),
            SizedBox(height: SpacingTokens.sectionSpacing),
          ],

          // Filter Bar
          ContextFilterBar(
            selectedType: _selectedType,
            searchQuery: _searchQuery,
            onTypeChanged: (type) => setState(() => _selectedType = type),
            onSearchChanged: (query) => setState(() => _searchQuery = query),
          ),

          SizedBox(height: SpacingTokens.elementSpacing),

          // Documents Grid
          if (filteredDocuments.isEmpty)
            _buildEmptyState(context)
          else
            _buildDocumentsGrid(context, filteredDocuments),
        ],
      ),
    );
  }

  Widget _buildEmptyState(BuildContext context) {
    final colors = ThemeColors(context);
    
    return const Center(
      child: AsmblCardEnhanced.accent(
        isInteractive: false,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              Icons.library_books_outlined,
              size: 64,
              color: colors.onSurfaceVariant.withValues(alpha: 0.5),
            ),
            SizedBox(height: SpacingTokens.componentSpacing),
            Text(
              _searchQuery.isNotEmpty || _selectedType != null
                  ? 'No documents match your filters'
                  : 'No context documents yet',
              style: TextStyles.cardTitle.copyWith(
                color: colors.onSurface,
              ),
            ),
            SizedBox(height: SpacingTokens.iconSpacing),
            Text(
              _searchQuery.isNotEmpty || _selectedType != null
                  ? 'Try adjusting your search or filter criteria'
                  : 'Create your first context document to get started',
              style: TextStyles.bodyMedium.copyWith(
                color: colors.onSurfaceVariant,
              ),
              textAlign: TextAlign.center,
            ),
            if (_searchQuery.isEmpty && _selectedType == null) ...[
              SizedBox(height: SpacingTokens.componentSpacing),
              AsmblButtonEnhanced.accent(
                text: 'Create Document',
                icon: Icons.add,
                onPressed: () => setState(() => _showCreateForm = true),
                size: AsmblButtonSize.medium,
              ),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildDocumentsGrid(BuildContext context, List<ContextDocument> documents) {
    return LayoutBuilder(
      builder: (context, constraints) {
        // Calculate number of columns based on available width
        const cardMinWidth = 350.0;
        const spacing = SpacingTokens.elementSpacing;
        final availableWidth = constraints.maxWidth;
        final columns = ((availableWidth + spacing) / (cardMinWidth + spacing)).floor().clamp(1, 4);
        
        return GridView.builder(
          shrinkWrap: true,
          physics: const NeverScrollableScrollPhysics(),
          gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
            crossAxisCount: columns,
            crossAxisSpacing: spacing,
            mainAxisSpacing: spacing,
            childAspectRatio: 1.2,
          ),
          itemCount: documents.length,
          itemBuilder: (context, index) {
            final document = documents[index];
            return ContextDocumentCard(
              document: document,
              onEdit: (updatedDocument) async {
                await ref.read(contextRepositoryProvider).updateDocument(updatedDocument);
                ref.invalidate(contextDocumentsProvider);
              },
              onDelete: (documentId) async {
                await ref.read(contextRepositoryProvider).deleteDocument(documentId);
                ref.invalidate(contextDocumentsProvider);
              },
              onAssignToAgent: (documentId) {
                // Navigate to agent assignment
                context.go('${AppRoutes.agents}?assign_context=$documentId');
              },
            );
          },
        );
      },
    );
  }
}